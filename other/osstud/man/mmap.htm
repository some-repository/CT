<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251">
<TITLE>mmap</TITLE>
</HEAD>
<BODY LINK="#0000ff" VLINK="#800080" BGCOLOR="#ffffff" topmargin="30" leftmargin="30">

<H1 ALIGN="CENTER"><FONT FACE="Times New Roman">Системный вызов mmap</font></H1>
<B><FONT FACE="Times New Roman" SIZE=5><P>Прототип системного вызова</P></FONT>
</B>
<DIR><FONT COLOR="#008000"> 
  <BLOCKQUOTE><b>#include &lt;sys/types.h&gt;<br>
  #include &lt;unistd.h&gt;<br>
    #include &lt;sys/mman.h&gt; </b></BLOCKQUOTE>
  <BLOCKQUOTE><b>void *mmap (void *start, size_t length, int prot, int flags, 
    int fd, off_t offset);</b></BLOCKQUOTE>
  </font></DIR>

<B><FONT FACE="Times New Roman" SIZE=5><P>Описание системного вызова</P></font></B>
<DIR><FONT FACE="Times New Roman" SIZE=5><B> </b></font> 
  <BLOCKQUOTE> 
    <p align="JUSTIFY"><FONT FACE="Times New Roman">Системный вызов</font> <B><font color="#008000">mmap</font></B><FONT FACE="Times New Roman"> 
      служит для отображения предварительно открытого файла (например, с помощью 
      системного вызоваа <a href="open.htm">open()</a>) в адресное пространство 
      вычислительной системы. После его выполнения файл может быть закрыт (например, 
      системным вызовом <a href="close.htm">close()</a>), что никак не повлияет 
      на дальнейшую работу с отображенным файлом.</FONT> 
  </BLOCKQUOTE>
  <BLOCKQUOTE> 
    <p align="JUSTIFY"><FONT FACE="Times New Roman">Настоящее описание не является 
      полным описанием системного вызова, а предназначено только для использования 
      в рамках данного курса. Для получения полной информации обращайтесь к UNIX 
      Manual. <br>
      <br>
      Параметр <b><font color="#008000">fd</font></b> является файловым дескриптором 
      для файла, который мы хотим отобразить в адресное пространство (т.е. значением, 
      которое вернул системный вызов <a href="open.htm">open()</a>). <br>
      <br>
      Ненулевое значение параметра <b><font color="#008000">addr</font></b> может 
      использоваться только очень квалифицированными системными программистами, 
      поэтому мы на наших занятиях будем асегда полагать его равным значению <b><font color="#008000">NULL</font></b>, 
      позволяя операционной системе самой выбрать начало области адресного пространства, 
      в которую будет отображен файл.<br>
      <br>
      В память будет отображаться часть файла, начиная с позиции внутри его, заданной 
      значением параметра <b><font color="#008000">offset</font></b> - смещение 
      от начала файла в байтах, и длиной равной значению параметра <b><font color="#008000">length</font></b> 
      (естественно, тоже в байтах). Значение параметра <b><font color="#008000">length 
      </font></b>можно указать и существенно большим, чем реальная длина от позиции 
      <b> <font color="#008000">offset</font></b> до конца существующего файла. 
      На поведении системного вызова это никак не отразится, но в дальнейшем при 
      попытке доступа к ячейкам памяти, лежащим вне границ реального файла, возникнет 
      сигнал <b><font color="#008000">SIGBUS</font></b> (реакция на него по умолчанию 
      - прекращение процесса с образованием core файла).<br>
      <br>
      Параметр<b><font color="#008000"> flags</font></b> определяет способ отображения 
      файла в адресное пространство. В рамках нашего курса мы будем использовать 
      только два его возможных значения: <b><font color="#008000">MAP_SHARED</font></b> 
      и <b><font color="#008000">MAP_PRIVATE</font></b>. Если в качестве его значения 
      выбрано <b><font color="#008000">MAP_SHARED</font></b>, то полученное отображение 
      файла впоследствии будет использоваться и другими процессами, вызвавшими 
      <b> <font color="#008000">mmap</font></b> для этого файла с аналогичными 
      значениями параметров, а все изменения, сделанные в отображенном файле, 
      <u>будут сохранены</u> во вторичной памяти. Если в качестве значения параметра 
      <b> <font color="#008000">flags</font></b> указано <b><font color="#008000">MAP_PRIVATE</font></b>, 
      то процесс получает отображение файла в свое монопольное распоряжение, но 
      все изменения в нем <u>не могут быть занесены</u> во вторичную память (т.е., 
      проще говоря, не сохранятся).<br>
      <br>
      Параметр <b><font color="#008000">prot</font></b> определяет разрешенные 
      операции над областью памяти, в которую будет отображен файл. В качестве 
      его значения мы будем использовать значения <b> <font color="#008000">PROT_READ</font></b> 
      (разрешено чтение), <b><font color="#008000">PROT_WRITE</font></b> (разрешена 
      запись) или их комбинацию через операцию &quot;побитовое или&quot; - &quot;|&quot;. 
      Необходимо отметить две существенные особенности системного вызова, связанные 
      с этим параметром:<br>
      <br>
      </font> 
  </BLOCKQUOTE>
  <BLOCKQUOTE> 
    <p align="JUSTIFY"> 
    <FONT FACE="Times New Roman"> 
    <dir> 
      <ol>
        <li><FONT FACE="Times New Roman"> Значение параметра prot не может быть 
          шире, чем операции над файлом, заявленные при его открытии в параметре 
          <b> <font color="#008000">flags</font></b> системного вызова <a href="open.htm">open()</a>. 
          Например, нельзя открыть файл только для чтения, а при его отображении 
          в память использовать значение <b><font color="#008000">prot = PROT_READ 
          | PROT_WRITE</font></b>.</font></li>
        <li>В результате ошибки в операционной системе Linux при работе на 486-х 
          и 586-х процессорах попытка записать в отображение файла, открытое только 
          для записи, более 32-х байт одновременно приводит к ошибке (возникает 
          сигнал о нарушении защиты памяти).</li>
      </ol>
    </dir>
    <br>
    </FONT> </BLOCKQUOTE>
  <BLOCKQUOTE> 
    <p align="JUSTIFY"><FONT FACE="Times New Roman">При нормальном завершении 
      системный вызов возвращает начальный адрес области памяти, в которую отображен 
      файл (или его часть), при возникновении ошибки - специальное значение <b><font color="#008000">MAP_FAILED</font></b> 
      .</font> 
  </BLOCKQUOTE>
</DIR>
</BODY>
</HTML>
