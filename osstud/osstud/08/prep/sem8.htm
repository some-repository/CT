<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251">
<TITLE>Семинар 8</TITLE>
</HEAD>
  <BODY bgcolor="#FFFFFF">
 <basefont face="Times New Roman" size="3">
 
 
<P ALIGN="CENTER"><B><FONT FACE="Times New Roman" SIZE = 6>Семинар 8. Семафоры 
  в UNIX как средство синхронизации процессов.</FONT></B></P>
<P ALIGN="CENTER">(Основывается на <a href="../../05/l5.htm">лекции 5</a> и <a href="../../06/l6.htm">лекции 6</a>) </P>
<P align="center"><a href="../../06/prep/sem6-7.htm"> Предыдущий семинар</a> | <a href="../../os.html">Программа курса</a> | 
 <a href="../../09/prep/sem9.htm"> Следующий семинар</a></P>
<P ALIGN="CENTER"><B><font face="Times New Roman, Times, serif" size="4">Программа 
  семинара</font></B></P>
    <ol>
  <li><a href="#s0801"><P ALIGN="JUSTIFY"><font face="Times New Roman, Times, serif" size="3">
  Семафоры в UNIX. Отличие операций над UNIX
  семафорами от классических операций. </font></a></li>
 <li><a href="#s0802">
    <P ALIGN="JUSTIFY"><font face="Times New Roman, Times, serif" size="3"> Создание 
      массива семафоров или доступ к уже существующему. Системный вызов semget(). 
      </font>
    </a></li>
  <li><a href="#s0803"><P ALIGN="JUSTIFY"><font face="Times New Roman, Times, serif" size="3">
Выполнение операций над семафорами. Системный вызов semop(). </font></a></li>
 <li><a href="#s0806"><P ALIGN="JUSTIFY"><font face="Times New Roman, Times, serif" size="3">
  Удаление набора семафоров из системы с помощью команды 
  ipcrm или системного вызова  semctl(). </font></a></li>
  <li><a href="#s0809"><P ALIGN="JUSTIFY"><font face="Times New Roman, Times, serif" size="3">
Понятие о POSIX семафорах. </font></a></li>
</ol>
<p align="center">
<font face="Times New Roman, Times, serif" size="3"><B><font size="4">Цели занятия</font></B></font> 
<OL>
  <li>
    <P ALIGN="JUSTIFY"><font face="Times New Roman" size="3">Дать навыки работы 
      с семафорами в UNIX. Хотя работа с семафорами является достаточно простой 
      идеологически, эта тема вызывает у студентов серьезные затруднения из-за 
      сложности семантики системного вызова <a href="../../man/semop.htm">semop()</a>.</font> 
  </li>
  <li>
    <P ALIGN="JUSTIFY"><font face="Times New Roman" size="3">Дать представление о существовании POSIX семафоров.</font> 
  </li>
</ol>

<P ALIGN="CENTER"><font face="Times New Roman, Times, serif" size="3"><B><font size="4">Практические 
  работы</font></B></font></P>
  
<OL>
  <li>
    <P ALIGN="JUSTIFY"><font face="Times New Roman, Times, serif" size="3"><a href="#s0804"> 
      Прогон примера с использованием семафора.</a></font> 
  </li>
	 <li>
    <P ALIGN="JUSTIFY"><font face="Times New Roman, Times, serif" size="3"><a href="#s0805"> 
      Изменение предыдущего примера.</a></font> 
  </li>
	 <li>
    <P ALIGN="JUSTIFY"><font face="Times New Roman, Times, serif" size="3"><a href="#s0807"> 
      Написание, компиляция и прогон программы с организацией взаимоисключения 
      с помощью семафоров для 2-х процессов, взаимодействующих через разделяемую 
      память.</a></font> 
  </li>
	 <li>
    <P ALIGN="JUSTIFY"><font face="Times New Roman, Times, serif" size="3"><a href="#s0808"> 
    Написание, компиляция и прогон 
	 программы с организацией взаимной очередности 
      с помощью семафоров для 2-х процессов, взаимодействующих через  pipe.</a></font> </li>
  </ol>
<P ALIGN="CENTER">&nbsp;</P>
<P ALIGN="CENTER"><B><font face="Times New Roman, Times, serif" size="4">План
занятия</font></B></P>
<ol>
  <LI> 
    <p align="JUSTIFY"><font  face="Times New Roman, Times, serif" size="3" color="#FF0000"><b><a name="s0801"></a>Семафоры 
      в UNIX. Отличие операций над UNIX семафорами от классических операций. </b></font> 
      <br>
      <br>
    <p align="JUSTIFY"> <font face="Times New Roman, Times, serif" size="3"> На 
      <a href="../../06/prep/sem6-7.htm#s0615">предыдущем семинаре</a> мы говорили 
      о необходимости синхронизации работы процессов для их корректного взаимодействия 
      через разделяемую память. <a href="../../06/ch6.htm#l0601"><img border="0" src="../../images/bookopen.gif" 
    alt="Семафоры в лекции" align="right" hspace="10" vspace="1" width="48" height="34"></a> 
      Как упоминалось на лекции, одним из первых механизмов, предложенных для 
      синхронизации поведения процессов, стали семафоры, концепцию которых описал 
      Дейкстра (Dijkstra) в 1965 году. При разработке средств System V IPC семафоры 
      вошли в их состав как неотъемлемая часть. Следует отметить, что набор операций 
      над семафорами System V IPC отличается от классического набора операций 
      <b> <font color="#008000">{P, V }</font></b>, предложенного Дейкстрой. Он 
      насчитывает три операции: </font> 
    <ul type="square">
      <br>
      <font face="Times New Roman, Times, serif" size="3"> 
      <li> 
        <p align="JUSTIFY"><font color="#008000"><b><a name="s0801a"></a> A(S, 
          n)</b></font> - увеличить значение семафора <b><font color="#008000">S</font></b> 
          на величину <b> <font color="#008000">n</font></b>; 
      </li>
      <li> 
        <p align="JUSTIFY"><font color="#008000"><b>D(S, n)</b></font> - пока 
          значение семафора <b><font color="#008000">S&nbsp;&lt;&nbsp;n</font></b> 
          процесс блокируется. Далее 
        <dir><b><font color="#008000">S&nbsp;=&nbsp;S&nbsp;-&nbsp;n</font></b>; 
        </dir>
      </li>
      <li> 
        <p align="JUSTIFY"><font color="#008000"><b>Z(S)</b></font> - процесс 
          блокируется до тех пор, пока значение семафора <b><font color="#008000">S</font></b> 
          не станет равным <b><font color="#008000">0</font></b>. 
      </li>
      <br>
      </font> 
    </ul>
    <p align="JUSTIFY"><font face="Times New Roman, Times, serif" size="3"> Изначально 
      все IPC семафоры инициируются нулевым значением.<br>
      <br>
      Легко видеть, что классической операции<b><font color="#008000"> P(S)</font></b> 
      соответствует операция <b><font color="#008000">D(S,1)</font></b>, а классической 
      операции <b><font color="#008000">V(S)</font></b> соответствует операция 
      <b> <font color="#008000">A(S,1)</font></b>. Аналогом ненулевой инициализации 
      Дейкстровских семафоров значением <b><font color="#008000">n</font></b> 
      может служить выполнение операции <b><font color="#008000">A(S,n)</font></b> 
      сразу после создания семафора <b><font color="#008000">S</font></b>, с обеспечением 
      атомарности создания семафора и ее выполнения посредством другого семафора. 
      Мы показали, что классические семафоры реализуются через семафоры System 
      V IPC. Обратное не является верным. Используя операции <b><font color="#008000">P(S)</font></b> 
      и <b><font color="#008000">V(S)</font></b>, мы не сумеем реализовать операцию 
      <b><font color="#008000">Z(S)</font></b>.<br>
      <br>
      Поскольку IPC семафоры являются составной частью средств System V IPC, то 
      для них верно все, что говорилось об этих средствах в целом на <a href="../../06/prep/sem6-7.htm#s0602">предыдущем 
      семинаре</a>. IPC семафоры являются средством связи с непрямой адресацией, 
      требуют инициализации для организации взаимодействия процессов и специальных 
      действия для освобождения системных ресурсов по его окончании. Пространством 
      имен IPC семафоров является множество значений <a href="../../06/prep/sem6-7.htm#s0603">ключа</a>, 
      генерируемых с помощью функции <a href="../../man/ftok.htm">ftok()</a>. 
      Для совершения операций над семафорами системным вызовам в качестве параметра 
      передаются <a href="../../06/prep/sem6-7.htm#s0604">IPC дескрипторы</a> 
      семафоров, однозначно идентифицирующих их во всей вычислительной системе, 
      а вся информация о семафорах располагается в адресном пространстве ядра 
      операционной системы. Это позволяет организовывать через семафоры взаимодействие 
      процессов, даже не находящихся в системе одновременно.</font><br>
      &nbsp; 
  </LI>
  <LI> 
    <p align="JUSTIFY"><font  face="Times New Roman, Times, serif" size="3" color="#FF0000"><b><a name="s0802"></a>Создание 
      массива семафоров или доступ к уже существующему. Системный вызов semget(). 
      </b></font> <br>
      <br>
    <p align="JUSTIFY"> <font face="Times New Roman, Times, serif" size="3">В 
      целях экономии системных ресурсов операционная система UNIX позволяет создавать 
      не по одному семафору для каждого конкретного значения ключа, а связывать 
      с ключом целый массив семафоров (в Linux - до 500 семафоров в массиве, хотя 
      это количество может быть уменьшено системным администратором). Для создания 
      массива семафоров, ассоциированного с определенным ключом, или доступа по 
      ключу к уже существующему массиву используется системный вызов <a href="../../man/semget.htm">semget()</a>, 
      являющийся аналогом системного вызова <a href="../../man/shmget.htm">shmget()</a> 
      для разделяемой памяти, который возвращает значение IPC дескриптора для 
      этого массива. При этом существуют <a href="../../06/prep/sem6-7.htm#s0605a">те 
      же способы создания и доступа</a>, что и для разделяемой памяти. Вновь созданные 
      семафоры инициируются нулевым значением.</font> <br>
      &nbsp; 
  </LI>
  <LI> 
    <p align="JUSTIFY"> <font  face="Times New Roman, Times, serif" size="3" color="#FF0000"><b> 
      <a name="s0803"></a> Выполнение операций над семафорами. Системный вызов 
      semop().</b></font> <br>
      <br>
    <p align="JUSTIFY"> <font face="Times New Roman, Times, serif" size="3"> Для 
      выполнения операций <b><font color="#008000">A</font></b>,<b><font color="#008000"> 
      D</font></b> и<b><font color="#008000"> Z</font></b> над семафорами из массива 
      используется системный вызов <a href="../../man/semop.htm">semop()</a>, 
      обладающий довольно сложной семантикой. Разработчики System V IPC явно перегрузили 
      этот вызов, применяя его не только для выполнения всех трех операций, но 
      еще и для нескольких семафоров в массиве IPC семафоров одновременно. Для 
      правильного использования этого вызова необходимо выполнить следующие действия:</font> 
      <br>
      <br>
    <ol>
      <LI> 
        <p align="JUSTIFY"><font  face="Times New Roman, Times, serif" size="3"> 
          Определиться, для каких семафоров из массива вы хотите выполнить операции. 
          Необходимо иметь в виду, что все операции реально совершаются только 
          перед успешным возвращением из системного вызова, т.е. если вы хотите 
          выполнить операции <b><font color="#008000">A(S<sub>1</sub>,5)</font></b> 
          и<b><font color="#008000"> Z(S<sub>2</sub>)</font></b> в одном вызове 
          и оказалось, что <b><font color="#008000">S<sub>2</sub>&nbsp;!=&nbsp;0</font></b>, 
          то значение семафора <b><font color="#008000">S<sub>1</sub></font></b> 
          не будет изменено до тех пор, пока значение <b><font color="#008000">S<sub>2</sub> 
          </font></b>не станет равным <b><font color="#008000">0</font></b>. Порядок 
          выполнения операций в случае, когда процесс не переходит в состояние 
          <i> <b>ожидание</b></i> не определен. Так, например, при одновременном 
          выполнении операций<b><font color="#008000"> A(S<sub>1</sub>,1)</font></b> 
          и <b><font color="#008000">D(S<sub>2</sub>,1)</font></b> в случае <b><font color="#008000">S<sub>2</sub>&nbsp;&gt;&nbsp;1</font></b> 
          неизвестно, что выполнится раньше - уменьшение значения семафора <b><font color="#008000">S<sub>2</sub></font></b> 
          или увеличение значения семафора<b><font color="#008000"> S<sub>1</sub></font></b>. 
          Если порядок является для вас существенным, лучше применить несколько 
          вызовов вместо одного.</font> 
      </li>
      <LI> 
        <p align="JUSTIFY"><font  face="Times New Roman, Times, serif" size="3"> 
          После того как вы определились с количеством семафоров и совершаемыми 
          операциями, необходимо завести в программе массив из элементов типа 
          <b> <font color="#008000">struct sembuf </font></b> с размерностью равной 
          определенному количеству семафоров (если операция совершается только 
          над одним семафором можно, естественно, обойтись просто переменной). 
          Каждый элемент этого массива будет соответствовать операции над одним 
          семафором.</font> 
      </li>
      <LI> 
        <p align="JUSTIFY"> 
        <font  face="Times New Roman, Times, serif" size="3"> Заполнить элементы 
        массива. В поле <b><font color="#008000">sem_flg</font></b> каждого элемента 
        занести значение <b><font color="#008000">0</font></b> (с другими значениями 
        флагов мы на семинарах работать не будем). В поля <b><font color="#008000">sem_num</font></b> 
        и <b><font color="#008000">sem_op</font></b> занести номера семафоров 
        в массиве IPC семафоров и соответствующие коды операций. Семафоры нумеруются, 
        начиная с <b><font color="#008000">0</font></b>. Если у вас в массиве 
        всего один семафор, то он будет иметь номер <b><font color="#008000">0</font></b>. 
        Операции кодируются так: <br>
        <br>
        <dir> для выполнения операции <b><font color="#008000">A(S,n)</font></b> 
          значение поля <b><font color="#008000">sem_op </font></b>должно быть 
          равно<b><font color="#008000"> n</font></b>.<br>
          для выполнения операции <b><font color="#008000">D(S,n)</font></b> значение 
          поля <b><font color="#008000">sem_op</font></b> должно быть равно <b><font color="#008000">-n</font></b>.<br>
          для выполнения операции <b><font color="#008000">Z(S)</font></b> значение 
          поля <b><font color="#008000">sem_op</font></b> должно быть равно<b><font color="#008000"> 
          0</font></b>.<br>
          <br>
        </dir>
        </font> </li>
      <LI> 
        <p align="JUSTIFY"><font  face="Times New Roman, Times, serif" size="3"> 
          В качестве второго параметра системного вызова <a href="../../man/semop.htm">semop()</a> 
          указать адрес заполненного массива, а в качестве третьего параметра 
          - ранее определенное количество семафоров, над которыми совершаются 
          операции. </font> 
      </li>
    </ol>
    <br>
    &nbsp; </LI>
  <LI> 
    <p align="JUSTIFY"> <font  face="Times New Roman, Times, serif" size="3" color="#FF0000"><b> 
      <a name="s0804"></a> Прогон примера с использованием семафора.</b></font> 
      <br>
      <br>
    <p align="JUSTIFY"> <font face="Times New Roman, Times, serif" size="3">Для 
      иллюстрации вышесказанного давайте рассмотрим простейшие <a href="../stud/08-1c.htm">программы,</a> 
      синхронизирующие свои действия с помощью семафоров (файлы /ftp/pub/sem8/stud/08-1a.c 
      и /ftp/pub/sem8/stud/08-1b.c). <a href="../stud/08-1ca.htm">Первая программа</a> 
      выполняет над семафором<b><font color="#008000"> S</font></b> операцию <b><font color="#008000">D(S,1)</font></b>, 
      <a href="../stud/08-1cb.htm">вторая программа</a> выполняет над тем же семафором 
      операцию<b><font color="#008000"> A(S,1)</font></b>. Если семафор не существует 
      в системе, любая программа создает его перед выполнением операции. Поскольку 
      при создании семафор всегда инициируется<b><font color="#008000"> 0</font></b>, 
      то <a href="../stud/08-1ca.htm">программа 1</a> может работать без блокировки 
      только после запуска <a href="../stud/08-1cb.htm">программы 2</a> . <br>
      </font> &nbsp; 
  </LI>
  <LI> 
    <p align="JUSTIFY"> <font  face="Times New Roman, Times, serif" size="3" color="#FF0000"><b> 
      <a name="s0805"></a> Изменение предыдущего примера.</b></font> <br>
      <br>
    <p align="JUSTIFY"> <font face="Times New Roman, Times, serif" size="3"> Измените предыдущие <a href="../stud/08-1c.htm">программы</a>, так чтобы 
      первая программа могла работать без блокировки после не менее 5 запусков 
      второй программы. </font> <br>
      &nbsp; 
  </LI>
  <LI> 
    <p align="JUSTIFY"> <font  face="Times New Roman, Times, serif" size="3" color="#FF0000"><b> 
      <a name="s0806"></a>Удаление набора семафоров из системы с помощью команды 
      ipcrm или системного вызова semctl(). </b></font> <br>
      <br>
    <p align="JUSTIFY"> 
    <font face="Times New Roman, Times, serif" size="3"> <img border="0" src="../../images/znak.gif" align="left" vspace="2" alt="Nota bene" hspace="10"> 
    Как мы говорили и видели из примеров, массив семафоров может продолжать существовать 
    в системе и после завершения использовавших его процессов, а семафоры будут 
    сохранять свое значение. Это способно привести к неправильному поведению программ, 
    предполагающих, что семафоры были только что созданы и, следовательно, имеют 
    нулевое значение. Необходимо удалять семафоры из системы перед запуском таких 
    программ или перед их завершением. Для удаления семафоров можно воспользоваться 
    командами<a href="../../man/ipcs.htm"> ipcs</a> и <a href="../../man/ipcrm.htm">ipcrm</a>, 
    рассмотренными на <a href="../../06/prep/sem6-7.htm#s0607">предыдущем семинаре</a>. 
    Команда <a href="../../man/ipcrm.htm">ipcrm</a> в этом случае должна иметь 
    вид 
    <p align="center"><b> <font color="#008000"><a href="../../man/ipcrm.htm">ipcrm</a> 
      sem &lt;IPC идентификатор</font></b>&gt;&nbsp;&nbsp;<br>
    </p>
    <p align="JUSTIFY"> Для этой же цели мы можем применять системный вызов <a href="../../man/semctl.htm">semctl()</a>, 
      который умеет выполнять и другие операции над массивом семафоров, но их 
      рассмотрение выходит за рамки нашего курса.</p>
    </font> </LI>
  <LI> 
    <p align="JUSTIFY"> <font  face="Times New Roman, Times, serif" size="3" color="#FF0000"><b> 
      <a name="s0807"></a>Написание, компиляция и прогон программы с организацией 
      взаимоисключения с помощью семафоров для 2-х процессов, взаимодействующих 
      через разделяемую память.</b></font> <br>
      <br>
    <p align="JUSTIFY"> <font face="Times New Roman, Times, serif" size="3"><a href="../stud/shpora.htm"> 
      <img border="0" src="../../images/book.gif" align="left" vspace="2" alt="Подсказка" hspace="10"></a> 
      На <a href="../../06/prep/sem6-7.htm#s0615">прошлом занятии</a> мы установили, 
      что любые неатомарные операции, связанные с изменением содержимого разделяемой 
      памяти, представляют собой критическую секцию процесса или нити исполнения. 
      Модифицируйте <a href="../../06/stud/06-3c.htm">программы</a> /ftp/pub/sem6-7/stud/06-3a.c 
      и /ftp/pub/sem6-7/stud/06-3b.c, которые иллюстрировали некорректную работу 
      через разделяемую память, обеспечив с помощью семафоров взаимоисключения 
      для их правильной работы. </font> <br>
      &nbsp; 
  </LI>
  <LI> 
    <p align="JUSTIFY"> <font  face="Times New Roman, Times, serif" size="3" color="#FF0000"><b> 
      <a name="s0808"></a> Написание, компиляция и прогон программы с организацией 
      взаимной очередности с помощью семафоров для 2-х процессов, взаимодействующих 
      через pipe.</b></font> <br>
      <br>
    <p align="JUSTIFY"> <font face="Times New Roman, Times, serif" size="3"> На 
      <a href="../../05/prep/sem5.htm#s0512">семинаре 5</a>, когда мы изучали 
      связь родственных процессов через pipe, мы говорили о том, что pipe является 
      однонаправленным каналом связи, и что для организации связи через один pipe 
      в двух направлениях необходимо использовать механизмы взаимной синхронизации 
      процессов. Организуйте двустороннюю поочередную связь процесса-родителя 
      и процесса-ребенка через pipe, используя для синхронизации семафоры, модифицировав 
      <a href="../../05/stud/05-3c.htm">программу</a> /ftp/pub/sem5/stud/05-3.c. 
      </font><br>
      &nbsp; 
  </LI>
  <LI> 
    <p align="JUSTIFY"> <font  face="Times New Roman, Times, serif" size="3" color="#FF0000"><b> 
      <a name="s0809"></a> Понятие о POSIX семафорах.</b></font> <br>
      <br>
    <p align="JUSTIFY"> <font face="Times New Roman, Times, serif" size="3"> В 
      стандарте POSIX вводятся другие семафоры, полностью аналогичные семафорам 
      Дейкстры. Для инициализации значения таких семафоров применяется функция 
      <b> <font color="#008000">sem_init()</font></b>, аналогом операции<b><font color="#008000"> 
      P</font></b> служит функция <b><font color="#008000">sem_wait()</font></b>, 
      а аналогом операции <b><font color="#008000">V</font></b>&nbsp;-&nbsp;функция 
      <b><font color="#008000">sem_post()</font></b>. К сожалению, в Linux такие 
      семафоры реализованы только для нитей исполнения внутри одного процесса, 
      и поэтому подробно мы на них останавливаться не будем.</font> <br>
      &nbsp; 
  </LI>
</ol>
<P align="center"><a href="../../06/prep/sem6-7.htm"> Предыдущий семинар</a> | <a href="../../os.html">Программа курса</a> | 
 <a href="../../09/prep/sem9.htm"> Следующий семинар</a></P>
</BODY>
</HTML>
